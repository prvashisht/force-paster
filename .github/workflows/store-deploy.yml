name: Store Deploy

on:
  # Triggers automatically when the Release workflow completes successfully.
  # (Using workflow_run instead of `release: published` because GitHub does not
  # fire webhook events for releases created by GITHUB_TOKEN from another workflow.)
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version to deploy (e.g. 2.3.0). Defaults to latest release.'
        required: false
        type: string
      stores:
        description: 'Which stores to deploy to'
        type: choice
        options: [all, chrome, firefox]
        default: all

permissions:
  contents: read

jobs:
  # ── Resolve which version/release to deploy ───────────────────────────────
  resolve:
    runs-on: ubuntu-latest
    # Skip if triggered by a failed Release workflow run
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    outputs:
      version: ${{ steps.resolve.outputs.version }}
    steps:
      - name: Resolve version
        id: resolve
        env:
          GH_TOKEN: ${{ github.token }}
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          if [ -n "$INPUT_VERSION" ]; then
            echo "version=$INPUT_VERSION" >> "$GITHUB_OUTPUT"
          else
            # Use the latest published release (covers both workflow_run and fallback manual)
            VERSION=$(gh release list --repo ${{ github.repository }} --limit 1 --json tagName -q '.[0].tagName' | sed 's/^v//')
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          fi

  # ── Chrome Web Store ──────────────────────────────────────────────────────
  chrome:
    needs: resolve
    runs-on: ubuntu-latest
    env:
      CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
    # Skip if: no version, secrets missing check is handled inline, or user chose firefox-only
    if: |
      needs.resolve.outputs.version != '' &&
      (github.event_name != 'workflow_dispatch' || inputs.stores == 'all' || inputs.stores == 'chrome')
    steps:
      - name: Check secrets
        id: check
        run: |
          if [ -z "$CHROME_CLIENT_ID" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "::warning::CHROME_CLIENT_ID not set — skipping Chrome Web Store deploy"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Download Chrome zip from release
        if: steps.check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download "v${{ needs.resolve.outputs.version }}" \
            --repo ${{ github.repository }} \
            --pattern "force-paster-chrome-v*.zip" \
            --dir .

      - name: Upload to Chrome Web Store
        if: steps.check.outputs.skip == 'false'
        uses: browser-actions/release-chrome-extension@latest
        with:
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          extension-path: force-paster-chrome-v${{ needs.resolve.outputs.version }}.zip
          oauth-client-id: ${{ secrets.CHROME_CLIENT_ID }}
          oauth-client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          oauth-refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}

  # ── Firefox Add-ons (AMO) ─────────────────────────────────────────────────
  firefox:
    needs: resolve
    runs-on: ubuntu-latest
    env:
      FIREFOX_API_KEY: ${{ secrets.FIREFOX_API_KEY }}
    if: |
      needs.resolve.outputs.version != '' &&
      (github.event_name != 'workflow_dispatch' || inputs.stores == 'all' || inputs.stores == 'firefox')
    steps:
      - name: Check secrets
        id: check
        run: |
          if [ -z "$FIREFOX_API_KEY" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "::warning::FIREFOX_API_KEY not set — skipping Firefox Add-ons deploy"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Download Firefox zip from release
        if: steps.check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download "v${{ needs.resolve.outputs.version }}" \
            --repo ${{ github.repository }} \
            --pattern "force-paster-firefox-v*.zip" \
            --dir .

      - name: Upload to Firefox Add-ons
        if: steps.check.outputs.skip == 'false'
        uses: wdzeng/firefox-addon@v1
        with:
          addon-guid: "{8159730a-851d-4416-bd8b-5d6117192c1f}"
          xpi-path: force-paster-firefox-v${{ needs.resolve.outputs.version }}.zip
          jwt-issuer: ${{ secrets.FIREFOX_API_KEY }}
          jwt-secret: ${{ secrets.FIREFOX_API_SECRET }}

  # Edge Add-ons: upload manually via https://partner.microsoft.com/dashboard/microsoftedge/overview
